<!-- /AP-Tool-Mini/index.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AP-Tool Mini</title>

<!-- Leaflet (map tiles + markers) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
  :root{--bg:#0b0c10;--fg:#e5e7eb;--mut:#94a3b8;--card:#10151b;--line:#1f2833}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100dvh}
  header,footer{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#111418;border-block:1px solid var(--line)}
  .title{font-weight:700;letter-spacing:.2px} .grow{flex:1}
  .pill{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:#cbd5e1;background:#182028}
  .pill.err{background:#3a1d1d;color:#ffb3b3;border-color:#5b2a2a}
  main{display:grid;gap:8px;padding:8px;overflow:auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .hd{padding:8px 10px;border-bottom:1px solid var(--line);color:#cbd5e1;font-weight:600;background:#111418}
  .bd{padding:8px 10px}
  #map{height:50vh;width:100%;background:#0a0a0a;border-radius:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  .k{font-size:12px;color:var(--mut)} .v{font-weight:700;font-size:18px}
  input,button{background:#121a22;color:#d4dee9;border:1px solid #2b3542;border-radius:8px;padding:6px 8px}
  button:active{transform:translateY(1px)}
  .row{display:flex;align-items:center;gap:6px;margin:4px 0}
  .mini{display:flex;gap:10px;align-items:baseline}
  .mini .item{display:flex;gap:6px;align-items:baseline}
  .targets{display:flex;flex-wrap:wrap;gap:6px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">AP-Tool Mini</div><div class="grow"></div>
    <div id="gpsPill" class="pill">GPS: idle</div>
    <div id="oriPill" class="pill">ORI: idle</div>
  </header>

  <main>
    <div class="card"><div class="hd">Map</div><div class="bd"><div id="map"></div></div></div>

    <div class="card">
      <div class="hd">HUD</div>
      <div class="bd grid">
        <div><div class="k">Heading (true)</div><div class="v"><span id="hdg">—</span>°</div></div>
        <div><div class="k">Pitch</div><div class="v"><span id="pit">—</span>°</div></div>
        <div><div class="k">Declination</div><div class="v"><span id="dec">—</span>°</div></div>
        <div><div class="k">Distance</div><div class="v"><span id="dst">—</span> m</div></div>
        <div><div class="k">Bearing</div><div class="v"><span id="brg">—</span>°</div></div>
        <div><div class="k">Pitch req</div><div class="v"><span id="preq">—</span>°</div></div>
        <div><div class="k">Heading offset</div><div class="v"><span id="off">—</span>°</div></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">Target</div>
      <div class="bd grid">
        <div>
          <div class="row"><label>Lat</label><input id="tlat" type="number" step="0.000001" style="width:140px"></div>
          <div class="row"><label>Lon</label><input id="tlon" type="number" step="0.000001" style="width:140px"></div>
          <div class="row"><label>Alt(m)</label><input id="talt" type="number" step="0.1" style="width:140px"></div>
          <div class="row"><button id="fromPin">Set from map pin</button></div>
        </div>
        <div>
          <div class="k" style="margin-bottom:6px">Quick Targets</div>
          <div class="targets" id="q"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="mini">
      <div class="item"><div class="k">Heading</div><div class="v" id="hdg2">—</div></div>
      <div class="item"><div class="k">Pitch</div><div class="v" id="pit2">—</div></div>
    </div>
    <div class="grow"></div>
    <button id="recenter">Recenter</button>
    <button id="perms">Request permissions</button>
  </footer>
</div>

<script>
(function(){
  // ----- math helpers -----
  const R=6371000, toRad=d=>d*Math.PI/180, toDeg:r=>r*180/Math.PI, n360:d=>((d%360)+360)%360;
  const dms=(a,b,c)=>Math.sin(c)*Math.cos(b), dmc=(a,b,c)=>Math.cos(a)*Math.sin(b)-Math.sin(a)*Math.cos(b)*Math.cos(c);
  const hb=(la1,lo1,la2,lo2)=>{const A=toRad(la1), B=toRad(la2), dA=toRad(la2-la1), dL=toRad(lo2-lo1);
    const a=Math.sin(dA/2)**2+Math.cos(A)*Math.cos(B)*Math.sin(dL/2)**2, c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    const dist=R*c, y=Math.sin(dL)*Math.cos(B), x=dmc(A,B,dL); return {dist,b:n360(toDeg(Math.atan2(y,x)))}};
  const preq=(vz,dist)=>toDeg(Math.atan2(vz,dist));
  const decl=(lat,lon)=>!isFinite(lat)||!isFinite(lon)?null:((lon<-30&&lon>-160)?6:0)+((lon>10&&lon<150)?-6:0)+(lat/90)*2;

  // ----- state -----
  const st={lat:null,lon:null,alt:null, hdgT:null, hdgM:null, pit:null, dec:null,
            t:{lat:null,lon:null,alt:null}};
  const $=id=>document.getElementById(id), set=(id,v)=>($(id).textContent=(v??'—'));

  // ----- map -----
  const map=L.map('map',{zoomControl:true}).setView([0,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  const me=L.marker([0,0]).addTo(map), tar=L.marker([0,0],{draggable:true}).addTo(map);
  tar.on('dragend',()=>{const p=tar.getLatLng(); setT(p.lat,p.lng,$('talt').value) });
  map.on('click',e=>setT(e.latlng.lat,e.latlng.lng,st.t.alt));

  // ----- UI wiring -----
  ['tlat','tlon','talt'].forEach(id=>$(id).addEventListener('change',()=>setT($('tlat').value,$('tlon').value,$('talt').value)));
  $('fromPin').onclick=()=>{const c=map.getCenter(); setT(c.lat,c.lng,$('talt').value)};
  $('recenter').onclick=()=>{if(isF(st.lat)&&isF(st.lon)) map.setView([st.lat,st.lon],Math.max(15,map.getZoom()))};
  $('perms').onclick=()=>{askOriPerm(); startGPS()};
  const isF=x=>typeof x==='number'&&isFinite(x);
  function setT(lat,lon,alt){
    st.t.lat=isF(+lat)?+lat:null; st.t.lon=isF(+lon)?+lon:null; st.t.alt=isF(+alt)?+alt:null;
    $('tlat').value=st.t.lat??''; $('tlon').value=st.t.lon??''; $('talt').value=st.t.alt??'';
    if(isF(st.t.lat)&&isF(st.t.lon)) tar.setLatLng([st.t.lat,st.t.lon]);
    aim();
  }

  // quick targets
  [{n:'Zero',a:[0,0,0]},{n:'SF',a:[37.7749,-122.4194,0]},{n:'Seattle',a:[47.6062,-122.3321,0]},{n:'NYC',a:[40.7128,-74.0060,0]}]
    .forEach(p=>{const b=document.createElement('button');b.textContent=p.n;b.onclick=()=>setT(...p.a); $('q').appendChild(b)});

  // ----- sensors: GPS -----
  function startGPS(){
    if(!('geolocation'in navigator)){pill('gpsPill','GPS: unsupported',1);return}
    pill('gpsPill','GPS: requesting');
    try{
      navigator.geolocation.watchPosition(pos=>{
        const c=pos.coords;
        st.lat=c.latitude; st.lon=c.longitude; st.alt=isF(c.altitude)?c.altitude:null;
        me.setLatLng([st.lat,st.lon]);
        st.dec=decl(st.lat,st.lon); set('dec',isF(st.dec)?(+st.dec).toFixed(1):'—');
        pill('gpsPill','GPS: ok'); aim();
      },e=>pill('gpsPill','GPS: error',1),{enableHighAccuracy:true,maximumAge:1000,timeout:8000});
    }catch{pill('gpsPill','GPS: error',1)}
  }

  // ----- sensors: ORIENTATION -----
  function pill(id,t,err){const el=$(id); el.textContent=t; el.classList.toggle('err',!!err)}
  function askOriPerm(){
    pill('oriPill','ORI: requesting');
    const D=window.DeviceOrientationEvent||window.webkitDeviceOrientationEvent;
    if(!D){pill('oriPill','ORI: unsupported',1);return}
    if(typeof D.requestPermission==='function'){
      D.requestPermission().then(r=>r==='granted'?attachOri():pill('oriPill','ORI: denied',1))
        .catch(()=>pill('oriPill','ORI: error',1));
    }else attachOri();
  }
  function attachOri(){
    if(window._oriOn)return; window._oriOn=1;
    window.addEventListener('deviceorientation',ev=>{
      let h=null,p=null,frame=null;
      if(typeof ev.webkitCompassHeading==='number'){h=ev.webkitCompassHeading;frame='earth'}
      else if(typeof ev.alpha==='number'){h=ev.alpha;frame=ev.absolute===true?'earth':'device'}
      if(typeof ev.beta==='number')p=Math.max(-90,Math.min(90,ev.beta));
      st.pit=isF(p)?p:null;

      if(isF(h)){
        if(frame==='earth'){st.hdgT=n360(h); st.hdgM=isF(st.dec)?n360(st.hdgT-st.dec):null}
        else{st.hdgM=n360(h); st.hdgT=isF(st.dec)?n360(st.hdgM+st.dec):null}
      }else{st.hdgT=st.hdgM=null}
      pill('oriPill','ORI: ok'); hud(); aim();
    });
  }

  // ----- HUD + AIM -----
  function hud(){
    set('hdg',isF(st.hdgT)?Math.round(st.hdgT):'—');
    set('pit',isF(st.pit)?Math.round(st.pit):'—');
    $('hdg2').textContent=$('hdg').textContent;
    $('pit2').textContent=$('pit').textContent;
  }
  function aim(){
    if(!(isF(st.lat)&&isF(st.lon)&&isF(st.t.lat)&&isF(st.t.lon)&&isF(st.hdgT))){
      set('dst','—'); set('brg','—'); set('preq','—'); set('off','—'); return;
    }
    const {dist,b}=hb(st.lat,st.lon,st.t.lat,st.t.lon);
    const vz=(isF(st.t.alt)&&isF(st.alt))?(st.t.alt-st.alt):null;
    set('dst',Math.round(dist));
    set('brg',Math.round(b));
    set('preq',isF(vz)?preq(vz,dist).toFixed(1):'—');
    set('off',Math.round(n360(b-st.hdgT)));
  }

  // ----- boot -----
  startGPS(); // start GPS immediately
  hud(); aim();
})();
</script>
</body>
</html>
